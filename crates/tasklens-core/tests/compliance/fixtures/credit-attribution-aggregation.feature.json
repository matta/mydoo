{
  "feature": "Credit Attribution - Ancestor Aggregation",
  "description": "Validates that parent/ancestor effective_credits aggregates decayed credits from all descendants. Per algorithm.md ยง5.1: \"Parent's stored credits remain unchanged, but its effective_credits reflects the child's contribution.\"\n",
  "background": {
    "current_time": "2025-01-01T00:00:00Z",
    "tasks": []
  },
  "scenarios": [
    {
      "name": "Parent Receives Effective Credits",
      "description": "Completing a child task adds the child's credit_increment to the child's credits. The parent's stored credits remain unchanged, but its effective_credits reflects the child's contribution.\n",
      "steps": [
        {
          "given": {
            "tasks": [
              {
                "id": "Parent",
                "credits": 0,
                "credit_increment": 1,
                "children": [
                  {
                    "id": "Child",
                    "credits": 0,
                    "credit_increment": 0.5
                  }
                ]
              }
            ]
          }
        },
        {
          "when": {
            "complete_tasks": [
              "Child"
            ]
          }
        },
        {
          "then": {
            "expected_props": [
              {
                "id": "Child",
                "credits": 0.5,
                "effective_credits": 0.5
              },
              {
                "id": "Parent",
                "credits": 0,
                "effective_credits": 0.5
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Deep Hierarchy Propagation",
      "description": "Effective credits propagate all the way up a three-level hierarchy. Only the completed leaf task has its stored credits updated.\n",
      "steps": [
        {
          "given": {
            "tasks": [
              {
                "id": "Root",
                "credits": 0,
                "children": [
                  {
                    "id": "Middle",
                    "credits": 0,
                    "children": [
                      {
                        "id": "Leaf",
                        "credits": 0,
                        "credit_increment": 0.8
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        {
          "when": {
            "complete_tasks": [
              "Leaf"
            ]
          }
        },
        {
          "then": {
            "expected_props": [
              {
                "id": "Leaf",
                "credits": 0.8,
                "effective_credits": 0.8
              },
              {
                "id": "Middle",
                "credits": 0,
                "effective_credits": 0.8
              },
              {
                "id": "Root",
                "credits": 0,
                "effective_credits": 0.8
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Ancestor Decay Plus Child Attribution",
      "description": "Parent has 100 credits. After 7 days, parent's credits decay to 50. Child completion adds 0.5 to child's credits only. Parent's effective_credits = decayed 50 + child's 0.5 = 50.5.\n",
      "steps": [
        {
          "given": {
            "tasks": [
              {
                "id": "Parent",
                "credits": 100,
                "children": [
                  {
                    "id": "Child",
                    "credits": 0,
                    "credit_increment": 0.5
                  }
                ]
              }
            ]
          }
        },
        {
          "when": {
            "advance_time_seconds": 604800,
            "complete_tasks": [
              "Child"
            ]
          }
        },
        {
          "then": {
            "expected_props": [
              {
                "id": "Child",
                "credits": 0.5,
                "effective_credits": 0.5
              },
              {
                "id": "Parent",
                "credits": 100,
                "effective_credits": 50.5
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Sibling Credits Independent",
      "description": "Completing one sibling does not affect another sibling's stored credits. Parent's effective_credits aggregates all children's contributions.\n",
      "steps": [
        {
          "given": {
            "tasks": [
              {
                "id": "Parent",
                "credits": 0,
                "children": [
                  {
                    "id": "ChildA",
                    "credits": 0,
                    "credit_increment": 0.5
                  },
                  {
                    "id": "ChildB",
                    "credits": 0,
                    "credit_increment": 0.3
                  }
                ]
              }
            ]
          }
        },
        {
          "when": {
            "complete_tasks": [
              "ChildA"
            ]
          }
        },
        {
          "then": {
            "expected_props": [
              {
                "id": "ChildA",
                "credits": 0.5,
                "effective_credits": 0.5
              },
              {
                "id": "ChildB",
                "credits": 0,
                "effective_credits": 0
              },
              {
                "id": "Parent",
                "credits": 0,
                "effective_credits": 0.5
              }
            ]
          }
        },
        {
          "when": {
            "complete_tasks": [
              "ChildB"
            ]
          }
        },
        {
          "then": {
            "expected_props": [
              {
                "id": "ChildA",
                "credits": 0.5,
                "effective_credits": 0.5
              },
              {
                "id": "ChildB",
                "credits": 0.3,
                "effective_credits": 0.3
              },
              {
                "id": "Parent",
                "credits": 0,
                "effective_credits": 0.8
              }
            ]
          }
        }
      ]
    }
  ]
}
