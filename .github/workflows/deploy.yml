name: Deploy Dioxus App

on:
  push:
    branches: ["deploy"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust
        uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install cargo-binstall
        uses: taiki-e/install-action@650c5ca14212efbbf3e580844b04bdccf68dac31 # v2
        with:
          tool: cargo-binstall

      - name: Install dioxus-cli
        run: |
          # Get the version of dioxus we're using to ensure CLI compatibility
          DIOXUS_VERSION=$(cargo tree -p dioxus --depth 0 --prefix none | cut -d v -f 2)
          echo "Installing dioxus-cli version $DIOXUS_VERSION"
          cargo binstall dioxus-cli --version $DIOXUS_VERSION --locked -y --force
          echo "Checking dx binary:"
          ls -l ~/.cargo/bin/dx || echo "dx not found in ~/.cargo/bin"
          echo "PATH is $PATH"
          which dx || echo "dx not found in PATH"

      - name: Build
        run: |
          # Build specifically for the web platform in release mode
          dx bundle --web --release -p tasklens-ui --debug-symbols=false --locked --out-dir=${{ runner.temp }}/bundle-out

      - name: Deploy to public branch
        uses: JamesIves/github-pages-deploy-action@d92aa235d04922e8f08b40ce78cc5442fcfbfa2f # v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: public
          folder: ${{ runner.temp }}/bundle-out/public
          clean: true
          single-commit: true
