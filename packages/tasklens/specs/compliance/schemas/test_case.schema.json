{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Tunnel Algorithm Test Case Schema",
  "type": "object",
  "required": ["name", "description", "initial_state", "steps"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Name of the scenario"
    },
    "description": {
      "type": "string",
      "description": "Comprehensive narrative explaining the test purpose"
    },
    "initial_state": {
      "type": "object",
      "required": ["current_time", "tasks"],
      "properties": {
        "current_time": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp with strictly numeric offset (e.g. +00:00)"
        },
        "timezone_offset": {
          "type": "integer",
          "default": 0,
          "description": "Offset in seconds from UTC. Defines the global timezone context for the test case. Defaults to 0 (UTC)."
        },
        "places": {
          "type": "array",
          "description": "List of Place definitions available in the test scenario.",
          "items": {
            "$ref": "#/definitions/Place"
          }
        },
        "tasks": {
          "type": "array",
          "description": "List of input Tasks defining the initial structure and state.",
          "items": {
            "$ref": "#/definitions/TaskInput"
          }
        }
      },
      "description": "The starting state of the system before any steps are executed."
    },
    "steps": {
      "type": "array",
      "description": "Sequence of mutation and assertion steps to execute.",
      "items": {
        "$ref": "#/definitions/Step"
      }
    }
  },
  "definitions": {
    "Place": {
      "type": "object",
      "description": "Represents a Context (Location + Time) constraint.",
      "required": ["id"],
      "properties": {
        "id": {
          "type": "string",
          "not": {"const": "Anywhere"},
          "description": "Unique Identifier for the Place. 'Anywhere' is reserved and cannot be used."
        },
        "hours": {
          "$ref": "#/definitions/OpenHours",
          "description": "Defines the operating hours for the place."
        },
        "included_places": {
          "type": "array",
          "description": "List of Place IDs included within this place context (one-level deep).",
          "items": {"type": "string"}
        }
      }
    },
    "TaskInput": {
      "type": "object",
      "description": "Input record for a Task, combining immutable spec and mutable state.",
      "required": ["id"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique Identifier (Primary Key)."
        },
        "children": {
          "type": "array",
          "description": "Recursive list of child tasks.",
          "items": {
            "$ref": "#/definitions/TaskInput"
          }
        },
        "title": {
          "type": "string",
          "description": "Display name or title of the task."
        },
        "importance": {
          "type": "number",
          "default": 1.0,
          "description": "(0.0â€“1.0) Importance relative to parent. Set by user."
        },
        "status": {
          "$ref": "#/definitions/TaskStatus",
          "default": "Pending",
          "description": "Current state ({ Pending, Done, Deleted }). Used to derive IsPending."
        },
        "credits": {
          "type": "number",
          "default": 0.0,
          "description": "Current total of decayed credit history for this task/subtree."
        },
        "credits_timestamp": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "Timestamp of last credit modification (t0 for decay calculations)."
        },
        "desired_credits": {
          "type": "number",
          "default": 1.0,
          "description": "Target allocation value (only valid for Root Goals)."
        },
        "due_date": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "Due Date for the task."
        },
        "place_id": {
          "type": ["string", "null"],
          "description": "Link to the Place this task belongs to. Inherits from Parent if Null."
        },
        "lead_time_seconds": {
          "type": "number",
          "default": 604800.0,
          "description": "Lead time in seconds. Defaults to 7 days (604800)."
        },
        "is_sequential": {
          "type": "boolean",
          "default": false,
          "description": "If true, children tasks are strictly ordered and blocked sequentially."
        }
      }
    },
    "Step": {
      "type": "object",
      "description": "A single stage in the test scenario involving mutations followed by assertions.",
      "required": ["name", "expected_order"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the step for reporting."
        },
        "view_filter": {
          "type": "string",
          "description": "The active View Filter context for this step (e.g. 'All Places', 'Home'). Defaults to 'All Places'."
        },
        "mutation": {
          "type": "object",
          "description": "State changes to apply before verification.",
          "properties": {
            "advance_time_seconds": {
              "type": "number",
              "description": "Seconds to advance the global clock."
            },
            "update_credits": {
              "type": "object",
              "description": "Map of TaskID to new Credit values (simulating manual adjustment).",
              "additionalProperties": {"type": "number"}
            },
            "task_updates": {
              "type": "array",
              "description": "List of updates to specific tasks (Status, Credits, etc.).",
              "items": {
                "type": "object",
                "required": ["id"],
                "properties": {
                  "id": {"type": "string"},
                  "status": {"$ref": "#/definitions/TaskStatus"},
                  "credits": {"type": "number"},
                  "desired_credits": {"type": "number"},
                  "importance": {"type": "number"},
                  "due_date": {
                    "type": ["string", "null"],
                    "format": "date-time"
                  }
                }
              }
            }
          }
        },
        "expected_order": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Exhaustive list of visible task IDs in strict order."
        },
        "expected_props": {
          "type": "array",
          "description": "List of partial task objects to verify specific state or computed properties.",
          "items": {
            "type": "object",
            "required": ["id"],
            "properties": {
              "id": {"type": "string"},
              "score": {"type": "number"},
              "effective_credits": {"type": "number"},
              "normalized_importance": {"type": "number"},
              "is_blocked": {"type": "boolean"},
              "is_visible": {"type": "boolean"},
              "is_ready": {"type": "boolean"},
              "is_open": {"type": "boolean"}
            }
          }
        }
      }
    },
    "OpenHoursRange": {
      "type": "string",
      "pattern": "^\\d{2}:\\d{2}-\\d{2}:\\d{2}$",
      "description": "Time range string in HH:MM-HH:MM format (24h)."
    },
    "OpenHours": {
      "type": "object",
      "description": "Defines when a Place is considered 'Open'.",
      "required": ["mode"],
      "properties": {
        "mode": {
          "$ref": "#/definitions/PlaceMode",
          "description": "Operating mode: 'always_open', 'always_closed', or 'custom'."
        },
        "schedule": {
          "type": "object",
          "description": "Weekly schedule mapping days to time ranges (required if mode is 'custom').",
          "patternProperties": {
            "^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)$": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/OpenHoursRange"
              }
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "PlaceMode": {
      "type": "string",
      "enum": ["always_open", "always_closed", "custom"],
      "description": "Operating mode: 'always_open', 'always_closed', or 'custom'."
    },
    "TaskStatus": {
      "type": "string",
      "enum": ["Pending", "Done", "Deleted"],
      "description": "Enumeration of possible task states."
    }
  }
}
