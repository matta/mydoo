feature: Credit Attribution on Task Completion
description: >
  Validates that completing a task adds its credit_increment to its own credits,
  applying decay before adding new credits, and updating credits_timestamp.
  See algorithm.md ยง5.1.
  
  NOTE: Scenarios requiring effective_credits aggregation from children are in
  credit-attribution-aggregation.feature.yaml (blocked on mydoo-59v).
background:
  current_time: "2025-01-01T00:00:00Z"
  tasks: []

scenarios:
  # ---------------------------------------------------------------------
  # 1. Basic Attribution (Single Task)
  # ---------------------------------------------------------------------
  - name: Single Task Completion
    description: >
      Completing a root task adds its credit_increment to its own credits.
    steps:
      - given:
          tasks:
            - id: TaskA
              credits: 0
              credit_increment: 0.5
      - when:
          complete_tasks:
            - TaskA
      - then:
          expected_props:
            - id: TaskA
              credits: 0.5
              effective_credits: 0.5

  # ---------------------------------------------------------------------
  # 2. Decay Before Attribution
  # ---------------------------------------------------------------------
  - name: Decay Applied Before Adding Credits
    description: >
      When a task with existing credits is completed, decay is applied to
      the existing balance before the new credit_increment is added.
      After 7 days (one half-life), 100 credits decay to 50, then +0.5 = 50.5.
    steps:
      - given:
          tasks:
            - id: TaskA
              credits: 100
              credit_increment: 0.5
      - when:
          advance_time_seconds: 604800
          complete_tasks:
            - TaskA
      - then:
          expected_props:
            - id: TaskA
              credits: 50.5
              effective_credits: 50.5

  # ---------------------------------------------------------------------
  # 3. Multiple Completions (Cumulative)
  # ---------------------------------------------------------------------
  - name: Cumulative Credits
    description: >
      Completing the same task twice (e.g., recurring) accumulates credits.
    steps:
      - given:
          tasks:
            - id: TaskA
              credits: 0
              credit_increment: 1.0
      - when:
          complete_tasks:
            - TaskA
      - then:
          expected_props:
            - id: TaskA
              credits: 1.0
              effective_credits: 1.0
      - when:
          complete_tasks:
            - TaskA
      - then:
          expected_props:
            - id: TaskA
              credits: 2.0
              effective_credits: 2.0
